<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다운폴</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #main,
        #result {
            display: none;
        }

        #main {
            display: block;
            margin-top: 50px;
            text-align: center;
        }

        #result {
            text-align: center;
            margin-top: 50px;
        }

        input[type="text"] {
            width: 50%;
            padding: 10px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .card-info {
            margin-top: 20px;
        }
    </style>
    <script>
        function goToMain() {
            document.getElementById('main').style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        function isEnglish(input) {
            const englishRegex = /^[A-Za-z\s]+$/;
            return englishRegex.test(input);
        }

        async function searchEnglishCards(input) {
            try {
                const response = await fetch(`https://moviejw.github.io/discord/list.json`);
                const files = await response.json();
                const filteredFiles = files.filter(file => file.startsWith(input));
                if (filteredFiles.length > 0) {
                    loadCardDetails(filteredFiles[0], input); 
                } else {
                    alert('검색 결과가 없습니다.');
                }
            } catch (error) {
                console.error('Error fetching English cards:', error);
                alert('검색 결과가 없습니다.');
            }
        }

        async function searchKoreanCards(input) {
            try {
                const response = await fetch('https://moviejw.github.io/preprocess/final_result.json');
                const data = await response.json();
                const card = Object.values(data).find(card => card.kor === input);
                if (card) {
                    searchEnglishCards(card.eng);
                } else {
                    alert('검색 결과가 없습니다.');
                }
            } catch (error) {
                console.error('Error fetching Korean cards:', error);
                alert('검색 결과가 없습니다.');
            }
        }


        async function loadCardDetails(fileName, input) {
            try {
                const response2 = await fetch(`https://moviejw.github.io/discord/${fileName}`);
                const cardData = await response2.json();

                const response3 = await fetch(`https://moviejw.github.io/preprocess/final_result.json`);
                const dictionData = await response3.json();

                document.getElementById('english-name').textContent = input;
                document.getElementById('korean-name').textContent = dictionData[input].kor;
                const imageUrl = getImage(dictionData[input].char, dictionData[input].type, input);
                document.getElementById('card-image').src = imageUrl;
                let messageContent = '';

                let previousAuthor = '';

                cardData.messages.forEach(message => {
                    const author = message.author.name;
                    let content = message.content;

                    if (content === "") return;

                    content = escapeHtml(content);
                    if (author !== previousAuthor) {
                        if (previousAuthor !== '') {
                            messageContent += '<br><br>'; 
                        }
                        previousAuthor = author;
                    }

                    messageContent += `<strong>${author}:</strong> ${content}<br>`;
                });

                document.getElementById('card-description').innerHTML = messageContent;
                document.getElementById('main').style.display = 'none';
                document.getElementById('result').style.display = 'block';
            } catch (error) {
                console.error('Error loading card details:', error);
                alert('검색 결과가 없습니다.');
            }
        }

        function handleSearch() {
            const input = document.getElementById('search-input').value.trim();
            if (input) {
                if (isEnglish(input)) {
                    searchEnglishCards(input);
                } else {
                    searchKoreanCards(input);
                }
            } else {
                alert('검색어를 입력해주세요.');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(new RegExp("[&<>\'\"']", 'g'), function(m) {
                return map[m];
            });
        }

        function getImage(char, type, name) {
            function formatName(char, name) {
                if (char === 'Hermit' || char === 'Gremlins') {
                    return name.toLowerCase().replace(/[' \-]+/g, '_');
                } else {
                    return name.replace(/[' \-]+/g, '').replace(/\b\w/g, char => char.toUpperCase());
                }
            }
            let imageUrl = '';
            let downfall = 'https://raw.githubusercontent.com/mikemayhemdev/DownfallSTS/master/src/main/resources/';

            switch (char) {
                case 'Hermit':
                    imageUrl = downfall + 'hermit' + "Resources/images/";
                    break;
                case 'Hexaghost':
                    imageUrl = downfall + 'hexamod' + "Resources/images/";
                    break;
                case 'Automaton':
                    imageUrl = downfall + 'bronze' + "Resources/images/";
                    break;
                case 'Champ':
                    imageUrl = downfall + 'champ' + "Resources/images/";
                    break;
                case 'Guardian':
                    imageUrl = downfall + 'guardian' + "Resources/images/";
                    break;
                case 'Gremlins':
                    imageUrl = downfall + 'gremlin' + "Resources/images/";
                    break;
                case 'Slime Boss':
                    imageUrl = downfall + 'slimebound' + "Resources/images/";
                    break;
                case 'Snecko':
                    imageUrl = downfall + 'sneckomod' + "Resources/images/";
                    break;
                case 'Collector':
                case 'Collectible': 
                    imageUrl = downfall + 'collector' + "Resources/images/";
                    break;
                case 'Misc':
                case 'Curse':
                case 'Boss':
                case 'Meta':
                    imageUrl = downfall + 'expansioncontent' + "Resources/images/";
                    break;
                default:
                    imageUrl = 'Image not found';
                    break;
            }

            imageUrl += type + 's/' + formatName(char, name);
            if (type == 'card') imageUrl += '_p.png';
            else imageUrl += '.png';

            return imageUrl;
        }
    </script>
</head>

<body>
    <div id="main">
        <h1>다운폴 일일토론</h1>
        <input type="text" id="search-input" placeholder="카드명을 정확히 입력하세요" onkeypress="handleKeyPress(event)">
        <button onclick="handleSearch()">검색</button>
    </div>

    <div id="result">
        <h1>상세</h1>
        <div class="card-info">
            <img id="card-image" src="" alt="Card Image" style="width: 200px; height: auto;">
        </div>
        <div class="card-info">
            <strong>한국어명:</strong> <span id="korean-name"></span>
        </div>
        <div class="card-info">
            <strong>영어명:</strong> <span id="english-name"></span>
        </div>
        <div class="card-info">
            <strong>토론:</strong> <span id="card-description"></span>
        </div>
        <button onclick="goToMain()">메인으로 돌아가기</button>
    </div>
</body>

</html>