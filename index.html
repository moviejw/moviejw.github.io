<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #main,
        #result {
            display: none;
        }

        #main {
            display: block;
            margin-top: 50px;
            text-align: center;
        }

        #result {
            text-align: center;
            margin-top: 50px;
        }

        input[type="text"] {
            width: 50%;
            padding: 10px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .card-info {
            margin-top: 20px;
        }
    </style>
    <script>
        // 메인 화면으로 돌아가기
        function goToMain() {
            document.getElementById('main').style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        // 입력값이 영어인지 한국어인지 확인하는 함수
        function isEnglish(input) {
            const englishRegex = /^[A-Za-z\s]+$/;
            return englishRegex.test(input);
        }

        // 영어일 경우 내 리포지토리에서 해당 파일 찾기
        async function searchEnglishCards(input) {
            try {
                const response = await fetch(`https://moviejw.github.io/discord/list.json`);
                const files = await response.json();
                // 입력한 문자열로 시작하는 파일 찾기
                const filteredFiles = files.filter(file => file.startsWith(input));
                if (filteredFiles.length > 0) {
                    loadCardDetails(filteredFiles[0], input); // 첫 번째 매칭 파일로 카드 정보 로드
                } else {
                    alert('카드를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('Error fetching English cards:', error);
            }
        }

        // 한국어일 경우 다른 리포지토리에서 JSON 파일을 읽어와서 매칭된 카드 찾기
        async function searchKoreanCards(input) {
            try {
                const response = await fetch('https://moviejw.github.io/preprocess/final_result.json'); // 한국어명이 있는 JSON 파일
                const data = await response.json();
                // 한국어명, 키값, 영문명으로 정렬하여 내 리포지토리에서 찾기
                const card = data.cards.find(card => card.koreanName === input);
                if (card) {
                    searchEnglishCards(card.englishName); // 영문명으로 다시 검색
                } else {
                    alert('카드를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('Error fetching Korean cards:', error);
            }
        }

        // 카드 세부 정보를 표시하는 함수
        async function loadCardDetails(fileName, input) {
            try {
                const response2 = await fetch(`https://moviejw.github.io/discord/${fileName}`);
                const cardData = await response2.json();

                const response3 = await fetch(`https://moviejw.github.io/preprocess/final_result.json`);
                const dictionData = await response3.json();

                document.getElementById('english-name').textContent = input;
                document.getElementById('korean-name').textContent = dictionData[input].kor;
                const imageUrl = getImage(dictionData[input].char, dictionData[input].type, input);
                document.getElementById('card-image').src = imageUrl;
                let messageContent = '';

                let previousAuthor = ''; // 이전 메시지 작성자의 이름을 저장

                cardData.messages.forEach(message => {
                    const author = message.author.name;
                    let content = message.content;

                    if (content === "") return;

                    content = escapeHtml(content);

                    // 새로운 작성자의 메시지가 나오면 줄바꿈 추가
                    if (author !== previousAuthor) {
                        if (previousAuthor !== '') {
                            messageContent += '<br><br>'; // 줄바꿈 두 번
                        }
                        previousAuthor = author;
                    }

                    // 메시지 작성자의 이름과 내용 추가
                    messageContent += `<strong>${author}:</strong> ${content}<br>`;
                });

                document.getElementById('card-description').innerHTML = messageContent;
                document.getElementById('main').style.display = 'none';
                document.getElementById('result').style.display = 'block';
            } catch (error) {
                console.error('Error loading card details:', error);
            }
        }

        // 입력 처리 함수
        function handleSearch() {
            const input = document.getElementById('search-input').value.trim();
            if (input) {
                if (isEnglish(input)) {
                    searchEnglishCards(input);
                } else {
                    searchKoreanCards(input);
                }
            } else {
                alert('검색어를 입력해주세요.');
            }
        }

        // 엔터키 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(new RegExp("[&<>\'\"']", 'g'), function(m) {
                return map[m];
            });
        }

        function getImage(char, type, name) {
            function formatName(char, name) {
                if (char === 'Hermit') {
                    // Convert name to snake_case for Hermit
                    return name.toLowerCase().replace(/[' \-]+/g, '_'); // Replace space, apostrophe, and hyphen with underscores
                } else {
                    // Convert name to CamelCase for others
                    return name.replace(/[' \-]+/g, '').replace(/\b\w/g, char => char.toUpperCase());
                }
            }
            let imageUrl = '';
            let downfall = 'https://raw.githubusercontent.com/mikemayhemdev/DownfallSTS/master/src/main/resources/';

            switch (char) {
                case 'Hermit':
                    imageUrl = downfall + 'hermit' + "Resources/images/";
                    break;
                case 'Hexaghost':
                    imageUrl = downfall + 'hexamod' + "Resources/images/";
                    break;
                case 'Automaton':
                    imageUrl = downfall + 'bronze' + "Resources/images/";
                    break;
                case 'Champ':
                    imageUrl = downfall + 'champ' + "Resources/images/";
                    break;
                case 'Guardian':
                    imageUrl = downfall + 'guardian' + "Resources/images/";
                    break;
                case 'Gremlins':
                    imageUrl = downfall + 'gremlin' + "Resources/images/";
                    break;
                case 'Slime Boss':
                    imageUrl = downfall + 'slimebound' + "Resources/images/";
                    break;
                case 'Snecko':
                    imageUrl = downfall + 'sneckomod' + "Resources/images/";
                    break;
                case 'Collector':
                case 'Collectible': // Same resource path for both Collector and Collectible
                    imageUrl = downfall + 'collector' + "Resources/images/";
                    break;
                case 'Misc':
                case 'Curse':
                case 'Boss':
                case 'Meta':
                    imageUrl = downfall + 'expansioncontent' + "Resources/images/";
                    break;
                default:
                    imageUrl = 'Image not found';
                    break;
            }

            imageUrl += type + 's/' + formatName(char, name);
            if (type == 'card') imageUrl += '_p.png';
            else imageUrl += '.png';

            return imageUrl;
        }
    </script>
</head>

<body>

    <!-- 메인 화면 -->
    <div id="main">
        <h1>다운폴 일일토론</h1>
        <input type="text" id="search-input" placeholder="카드명을 정확히 입력하세요" onkeypress="handleKeyPress(event)">
        <button onclick="handleSearch()">검색</button>
    </div>

    <!-- 결과 화면 -->
    <div id="result">
        <h1>카드 상세</h1>
        <div class="card-info">
            <strong>카드 이미지:</strong> 
            <img id="card-image" src="" alt="Card Image" style="width: 200px; height: auto;">
        </div>
        <div class="card-info">
            <strong>한국어명:</strong> <span id="korean-name"></span>
        </div>
        <div class="card-info">
            <strong>영어명:</strong> <span id="english-name"></span>
        </div>
        <div class="card-info">
            <strong>토론:</strong> <span id="card-description"></span>
        </div>
        <button onclick="goToMain()">메인으로 돌아가기</button>
    </div>
</body>

</html>